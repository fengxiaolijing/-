## 环境

| 服务机器     | 角色   | hostname       |
| ------------ | ------ | -------------- |
| 10.0.110.201 | Leader | swarm.master01 |
| 10.0.110.202 | node   | swarm.node01   |



## 公用服务

| 服务名   | 端口 | 账号密码      | 挂载存储目录                    | 挂载配置文件                           |
| -------- | ---- | ------------- | ------------------------------- | -------------------------------------- |
| rabbitmq | 5672 | uc/uc123456   |                                 |                                        |
| mysql    | 3306 | root/uc123456 | /root/scripts/uc/mysql/packages | /root/scripts/uc/mysql/tools/mysql.cnf |
| redis    | 6379 | uc123456      |                                 |                                        |





### MySQL

#### MySQL的ansible文件

```
---
- hosts: swarm
  gather_facts: no
  tasks:
    - name: Deploy stack from a compose file
      docker_stack:
        state: present
        name: mysql
        compose:
          - /root/swarm/uc/mysql/mysql.yml
        prune: yes
```

#### MySQLyml文件

```
version: '3'
services:
  mysql:
    image: mysql:latest
    environment:
      MYSQL_ROOT_PASSWORD: uc123456
    ulimits:
      nproc: 65535
      nofile:
        soft: 20000
        hard: 40000
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: "2"
          memory: 8g
      restart_policy:
        condition: on-failure
    ports:
      - "3306:3306"
    volumes:
      - /root/scripts/uc/mysql/tools/mysql.cnf:/etc/mysql/conf.d/mysql.cnf
      - /root/scripts/uc/mysql/packages:/var/lib/mysql
```

#### 验证服务

查看MySQL服务

```
[root@swarm mysql]# docker service ls | grep mysql
ss538eest5kd        mysql_mysql          replicated          1/1                 mysql:latest         *:3306->3306/tcp
```

用另一台机器远程登陆

```
[root@swarm ~]# mysql -uroot -puc123456 -h10.0.110.201
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 12
Server version: 8.0.18 MySQL Community Server - GPL

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> exit
Bye
```

