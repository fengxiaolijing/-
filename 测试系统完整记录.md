## 环境

| 服务机器     | 角色   | hostname       |
| ------------ | ------ | -------------- |
| 10.0.110.201 | Leader | swarm.master01 |
| 10.0.110.202 | node   | swarm.node01   |



## 公用服务

| 服务名   | 端口        | 账号密码      | 挂载存储目录                    | 挂载配置文件                           |
| -------- | ----------- | ------------- | ------------------------------- | -------------------------------------- |
| redis    | 6379        | uc123456      |                                 |                                        |
| mysql    | 3306        | root/uc123456 | /root/scripts/uc/mysql/packages | /root/scripts/uc/mysql/tools/mysql.cnf |
| rabbitmq | 5672/15672  | uc/uc123456   |                                 |                                        |
| canal    | 11111/11111 | root/uc123456 |                                 |                                        |

### Redis

redis.conf配置文件

```
bind 0.0.0.0
protected-mode no
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300

################################# GENERAL #####################################
databases 50

################################ SNAPSHOTTING  ################################
save 1 1
#save 900 1
save 300 10
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir ./

################################# REPLICATION #################################
slave-serve-stale-data yes
slave-read-only yes
repl-diskless-sync no
repl-diskless-sync-delay 5
repl-disable-tcp-nodelay no
slave-priority 100

################################## SECURITY ###################################
requirepass uc123456

################################### LIMITS ####################################
maxclients 10000

############################## APPEND ONLY MODE ###############################
appendonly yes

################################ LUA SCRIPTING  ###############################
lua-time-limit 5000

################################ REDIS CLUSTER  ###############################
cluster-enabled no

################################## SLOW LOG ###################################
slowlog-log-slower-than 10000
slowlog-max-len 128

################################ LATENCY MONITOR ##############################
latency-monitor-threshold 0

############################# EVENT NOTIFICATION ##############################
notify-keyspace-events ""

############################### ADVANCED CONFIG ###############################
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
activerehashing yes
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit slave 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60
aof-rewrite-incremental-fsync yes
```

Dockerfile做一个redis

```
FROM redis
COPY redis.conf /usr/local/etc/redis/redis.conf
CMD [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
```

生成容器

```
[root@swarm tools]# docker build -t redis:1.0.1 .
Sending build context to Docker daemon   7.68kB
Step 1/3 : FROM redis
 ---> 01a52b3b5cd1
Step 2/3 : COPY redis.conf /usr/local/etc/redis/redis.conf
 ---> 093fdc26f4ff
Step 3/3 : CMD [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
 ---> Running in 83f9acf9c362
Removing intermediate container 83f9acf9c362
 ---> 9937725add3c
Successfully built 9937725add3c
Successfully tagged redis:1.0.1
```

#### Redis的ansible文件

```
---
- hosts: swarm
  gather_facts: no
  tasks:
    - name: Deploy stack from a compose file
      docker_stack:
        state: present
        name: redis
        compose:
          - /root/swarm/uc/redis/redis.yml
        prune: yes
```

#### Redisyml文件

```
version: '3'
services:
  redis:
    image: redis:latest
    environment:
      requirepass: tahoecn123
    ulimits:
      nproc: 65535
      nofile:
        soft: 20000
        hard: 40000
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: "2"
          memory: 8g
      restart_policy:
        condition: on-failure
    ports:
      - "6379:6379"
    volumes:
      - /root/scripts/uc/redis/tools/redis.conf:/usr/local/etc/redis/redis.conf
      - /root/scripts/uc/redis/packages:/data

```

#### 验证服务

```
[root@swarm redis]# docker service ls | grep redis
1p3oyqjpbqjt        redis_redis          replicated          2/2                 redis:latest         *:6379->6379/tcp
```

密码登录

```
[root@swarm redis]# docker exec -it redis_redis.1.u1zssfsume5blsxjkcjw7mheo bash
root@c2747d8938e5:/data# redis-cli 
127.0.0.1:6379> auth uc123456
OK
```



### MySQL

#### MySQL的ansible文件

```
---
- hosts: swarm
  gather_facts: no
  tasks:
    - name: Deploy stack from a compose file
      docker_stack:
        state: present
        name: mysql
        compose:
          - /root/swarm/uc/mysql/mysql.yml
        prune: yes
```

#### MySQLyml文件

```
version: '3'
services:
  mysql:
    image: mysql:latest
    environment:
      MYSQL_ROOT_PASSWORD: uc123456
    ulimits:
      nproc: 65535
      nofile:
        soft: 20000
        hard: 40000
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: "2"
          memory: 8g
      restart_policy:
        condition: on-failure
    ports:
      - "3306:3306"
    volumes:
      - /root/scripts/uc/mysql/tools/mysql.cnf:/etc/mysql/conf.d/mysql.cnf
      - /root/scripts/uc/mysql/packages:/var/lib/mysql
```

#### 验证服务

查看MySQL服务

```
[root@swarm mysql]# docker service ls | grep mysql
ss538eest5kd        mysql_mysql          replicated          1/1                 mysql:latest         *:3306->3306/tcp
```

用另一台机器远程登陆

```
[root@swarm ~]# mysql -uroot -puc123456 -h10.0.110.201
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 12
Server version: 8.0.18 MySQL Community Server - GPL

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> exit
Bye
```

### rabbitmq

#### rabbitmq的ansible文件

```
---
- hosts: swarm
  gather_facts: no
  tasks:
    - name: Deploy stack from a compose file
      docker_stack:
        state: present
        name: rabbitmq
        compose:
          - /root/swarm/uc/rabbitmq/rabbitmq.yml
        prune: yes
```

#### rabbitmq的yml文件

```
version: '3'
services:
  rabbit:
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: uc
      RABBITMQ_DEFAULT_PASS: uc123456
    ulimits:
      nproc: 65535
      nofile:
        soft: 20000
        hard: 40000
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: "2"
          memory: 4g
      restart_policy:
        condition: on-failure
    ports:
      - "5672:5672"
      - "15672:15672"
```

#### 验证服务

打开浏览器输入IP地址:15672   账号密码  uc/uc123456



### canal

[canal官网链接](https://github.com/alibaba/canal)

canal景象

```
docker pull canal/canal-server
```

官网需要用一个run.sh脚本传递参数启动canal

#### 官网的例子

```
# 下载脚本
wget https://raw.githubusercontent.com/alibaba/canal/master/docker/run.sh 

# 构建一个destination name为test的队列
sh run.sh -e canal.auto.scan=false \
		  -e canal.destinations=test \
		  -e canal.instance.master.address=127.0.0.1:3306  \
		  -e canal.instance.dbUsername=canal  \
		  -e canal.instance.dbPassword=canal  \
		  -e canal.instance.connectionCharset=UTF-8 \
		  -e canal.instance.tsdb.enable=true \
		  -e canal.instance.gtidon=false  \
```

#### 运行canal容器脚本

```
 sh run.sh -e canal.instance.master.address=10.0.110.201:3306 -e canal.instance.dbUsername=root -e canal.instance.dbPassword=uc123456 -e canal.instance.connectionCharset=UTF-8 -e canal.instance.tsdb.enable=true -e canal.instance.gtidon=false -e canal.admin.port=11111
```

脚本运行的实际命令

```
docker run -d -it -p 11111:11111 -h 10.0.110.201 -e canal.instance.master.address=10.0.110.201:3306 -e canal.instance.dbUsername=root -e canal.instance.dbPassword=uc123456 -e canal.instance.connectionCharset=UTF-8 -e canal.instance.tsdb.enable=true -e canal.instance.gtidon=false -e canal.admin.port=11111 --name=canal-server -m 4096m canal/canal-server
dd0998e37d2443161b8b4c634647aece73d1fc66f6ab2693fa1aae411adad0db
```

#### 查看运行中的容器

```
[root@swarm ~]# docker ps | grep canal
dd0998e37d24        canal/canal-server      "/alidata/bin/main.s…"   11 seconds ago      Up 9 seconds        2222/tcp, 8000/tcp, 11112/tcp, 0.0.0.0:11111->11111/tcp                                      canal-server
```

